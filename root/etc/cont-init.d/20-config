#!/bin/bash

set -ex

PUID=${PUID:-0}
PGID=${PGID:-0}

# Functions
setup(){
  echo "Initialising google-drive-ocamlfuse..."
  echo "$VERIFICATION_CODE"
  env HOME=/config s6-setuidgid abc google-drive-ocamlfuse \
    -label "$LABEL" \
    -f \
    -cc \
    -skiptrash \
    -headless \
    -id "$CLIENT_ID.apps.googleusercontent.com" \
    -secret "$CLIENT_SECRET"

}

mount() {
  echo "Mounting at $DRIVE_PATH..."
  env HOME=/config s6-setuidgid abc google-drive-ocamlfuse $DRIVE_PATH \
    -o "noatime,uid=$PUID,gid=$PGID" \
    -label "$LABEL" \
    -f \
    -cc \
    -skiptrash \
    -headless

}

# make folders
mkdir -p \
	/config /downloads/complete /downloads/incomplete /watch

# copy config
[[ ! -f /config/settings.json ]] && cp \
	/defaults/settings.json /config/settings.json

[[ ! -f /config/.gdfuse/$LABEL/config ]] && cp \
	/defaults/gdrive-config /config/.gdfuse/$LABEL/config

# copy blocklist-update script
[[ ! -f /config/blocklist-update.sh ]] && cp \
	/defaults/blocklist-update.sh /config/blocklist-update.sh

# set the alterate root directory
sed -i "s/^root_folder=$/root_folder=$REMOTE_DIR/g" /config/.gdfuse/$LABEL/config
sed -i "s/^team_drive_id=$/team_drive_id=$TEAMDRIVE/g" /config/.gdfuse/$LABEL/config

# permissions
chown -R abc:abc /config /downloads /watch
chmod 755 /config/blocklist-update.sh

# begin gdrive-ocamlfuse startup
if [ -e "/config/.gdfuse/${LABEL}/config" ]; then
  echo "Notice: No Google Drive configuration found."
else
  if [ -z "$CLIENT_ID" ]; then
    echo "Fatal: no CLIENT_ID found -> EXIT"
    exit 1
  elif [ -z "$CLIENT_SECRET" ]; then
    echo "Fatal: no CLIENT_SECRET found -> EXIT"
    exit 1
  elif [ -z "$VERIFICATION_CODE" ]; then
    echo "Warning: no VERIFICATION_CODE found"
    setup
    exit 1
  else
    setup
  fi
fi

mount
